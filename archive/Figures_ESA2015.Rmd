---
title: 'Results: Systematic review of how we measure functional diversity'
author: "Marissa Lee"
date: "July 29, 2015"
output: pdf_document
---
```{r setup, include=FALSE}
knitr::opts_chunk$set(cache=TRUE)
```
_________________________________________________________________
# 0. Load libraries, functions, data
```{r load,echo=FALSE, warning=FALSE}
#set working directory
setwd("~/Dropbox/SHARED/Dimensions of biodiversity (so what?)/Analysis/Code")

#load libraries
library(magrittr)
#library(splitstackshape) #what does this package do?
library(plyr) 
library(reshape2)
library(doBy)
library(ggplot2)
library(gridExtra)

#To cite R and packages...
# citation()
# if(nchar(system.file(package="magrittr"))) citation("magrittr")
# if(nchar(system.file(package="splitstackshape"))) citation("splitstackshape")
# if(nchar(system.file(package="plyr"))) citation("plyr")
# if(nchar(system.file(package="reshape2"))) citation("reshape2")
# if(nchar(system.file(package="doBy"))) citation("doBy")
# if(nchar(system.file(package="ggplot2"))) citation("ggplot2")
# if(nchar(system.file(package="gridExtra"))) citation("gridExtra")

#read data
source('mytheme.R') #for ggplots
Study.Info<-read.delim("downloadedData/StudyInfoClean.csv", sep=",", header = TRUE, na.strings = "")
FD.Metrics<-read.delim("downloadedData/FDMetricsDetails.csv", sep=",", header = TRUE, na.strings = "")
Trait.Info<-read.delim("downloadedData/TraitInfo.csv", sep=",", header = TRUE, na.strings = "")
```

_________________________________________________________________
# 0. Clean data
```{r load,echo=FALSE, warning=FALSE}

####
#PROBLEM 1: Some rows that don't look like real traits...
Trait.Info[!is.na(Trait.Info$NOT.A.TRAIT.),]
dim(Trait.Info[!is.na(Trait.Info$NOT.A.TRAIT.),])

#SOLUTION 1: Remove trait rows that are likely not real traits
Trait.Info.real<-Trait.Info[is.na(Trait.Info$NOT.A.TRAIT.),] 


####
#PROBLEM 2: Studies that don't have trait info or only have 1 trait listed
#first, identify the unique ids in Trait.Info.real and count the number of trait rows per id
summ <- ddply(Trait.Info.real,~ID, summarise, nTrait=length(unique(Trait.Name))) 
#next, merge the table of ids x number of traits ('nTrait') with the Study.Info dataframe so that we have an accurate record of the number of trait rows per studyid row
Study.Info.numTr<-merge(Study.Info, summ, by='ID', all.x=TRUE)
#check out if the total.number.traits column that was already in Study.Info accurately reflects the current Trait.Info dataframe
Study.Info.numTr[40:60,c('total.number.traits','nTrait')] #it's not perfect, so just use 'nTrait'
#when 'nTrait' was merged, it added NAs where no traits were found in Trait.Info, so go back and make these NAs == 0
Study.Info.numTr[is.na(Study.Info.numTr$nTrait),'nTrait']<-0

#PROBLEM 2A: Which accepted IDs do not appear in Trait.Info?
answer1<-Study.Info.numTr[Study.Info.numTr$nTrait==0 & Study.Info.numTr$accept.reject=='accept','ID']
answer1
paste('ID =', paste(answer1, collapse=','), 'was called an accepted study but there is no matching ID in Trait.Info')

#PROBLEM 2B: Which accepted IDs do not have >1 trait in Trait.Info?
answer2<-Study.Info.numTr[Study.Info.numTr$nTrait==1 & Study.Info.numTr$accept.reject=='accept','ID']
answer2
paste('ID =', paste(answer2, collapse=','), 'was called an accepted study but there is only 1 trait in Trait.Info')

#SOLUTION 2: Change 'accept.reject' to 'reject' for problematic ids
Study.Info.numTr[Study.Info.numTr$ID %in% c(answer1, answer2),'accept.reject']<-'reject'


#keep only 'accept'
Study.Info.Subset<-Study.Info.numTr[Study.Info.numTr$accept.reject%in%c("accept"),] 
FD.Metrics.Subset<-FD.Metrics[FD.Metrics$acceptESA%in%c("accept"),] 
acceptIDs<-unique(Study.Info.Subset$ID)
Trait.Info.Subset<-Trait.Info.real[Trait.Info.real$ID %in% acceptIDs,]

#double check that Study.Info and Trait.Info have the same set of unique IDs
sum(!unique(Study.Info.Subset$ID) %in% unique(Trait.Info.Subset$ID)) #if 0, then all the IDs in studyInfo are in traitInfo
sum(!unique(Trait.Info.Subset$ID) %in% unique(Study.Info.Subset$ID)) #if 0, then all the IDs in traitInfo are in studyInfo

#convert to data frame 
Study.Info.Subset.DF<-as.data.frame(Study.Info.Subset)
FD.Metrics.Subset.DF<-as.data.frame(FD.Metrics.Subset)
Trait.Info.Subset.DF<-as.data.frame(Trait.Info.Subset)

#clean sys1 in Study.Info
unique(Study.Info.Subset.DF$sys1)
Study.Info.Subset.DF[Study.Info.Subset.DF$sys1 == 'A\n','sys1']<-'A'
Study.Info.Subset.DF[Study.Info.Subset.DF$sys1 == 'T\n','sys1']<-'T'
Study.Info.Subset.DF$sys1<-droplevels(Study.Info.Subset.DF$sys1)

#clean habitat in Study.Info
unique(Study.Info.Subset.DF$habitat)
Study.Info.Subset.DF[Study.Info.Subset.DF$habitat == 'TEMP\n','habitat']<-'TEMP'
Study.Info.Subset.DF[Study.Info.Subset.DF$habitat == 'GRAS\n','habitat']<-'GRAS'
Study.Info.Subset.DF$habitat<-droplevels(Study.Info.Subset.DF$habitat)

#make a compound category: sys1 x group
Study.Info.Subset.DF$sys1Grp<-paste(Study.Info.Subset.DF$sys1,Study.Info.Subset.DF$group, sep="_")
ddply(Study.Info.Subset.DF, ~sys1Grp, summarize,n=length(unique(ID)))
Study.Info.Subset.DF[Study.Info.Subset.DF$sys1Grp == 'A_animal','sys1Grp']<-'aquatic animal'
Study.Info.Subset.DF[Study.Info.Subset.DF$sys1Grp == 'A_plant','sys1Grp']<-'aquatic plant'
Study.Info.Subset.DF[Study.Info.Subset.DF$sys1Grp == 'T_animal','sys1Grp']<-'terrestrial animal'
Study.Info.Subset.DF[Study.Info.Subset.DF$sys1Grp == 'T_plant','sys1Grp']<-'terrestrial plant'
#simplify sys1Grp levels
Study.Info.Subset.DF[!Study.Info.Subset.DF$sys1Grp %in% 
                       c('aquatic animal','aquatic plant','terrestrial animal','terrestrial plant'),'sys1Grp']<-'other'
Study.Info.Subset.DF$sys1Grp<-factor(Study.Info.Subset.DF$sys1Grp, 
                                     levels=c('terrestrial plant','terrestrial animal','aquatic plant','aquatic animal','other'))

#quick index of sys1Grp by ID
id_sys1Grp<-data.frame(ID=Study.Info.Subset.DF$ID,sys1Grp=Study.Info.Subset.DF$sys1Grp)

#function to expand and melt variables with comma-separated data
ExpandMelt<-function(df, varName){
  #expand
  df.expanded<-cSplit(df, varName) 
  
  #melt
  otherColNames<-colnames(df)[colnames(df) != varName]
  df.expanded.melted<- melt(df.expanded, id=otherColNames) 
  
  #remove NAs
  df.expanded.melted<-df.expanded.melted[!is.na(df.expanded.melted$value),] 
  
  #rename columns
  setnames(df.expanded.melted, 'variable', paste('seq',varName, sep='_'))
  setnames(df.expanded.melted, 'value', varName)
  
  return(df.expanded.melted)
}
```

_________________________________________________________________
# RANDOM FOREST MODELS
```{r cartModels, echo=FALSE, warning=FALSE}
#Format mydata
str(Study.Info.Subset.DF)
Study.Info.Subset.DF$Total.Number.Species<-as.numeric(Study.Info.Subset.DF$Total.Number.Species)
mydata<-Study.Info.Subset.DF

#Random Forest model using 'party' and 'rpart'
library(party)
#ntree = number of trees in the forest; ntree should be increased as the number of variables or data points increase; more trees, more stable results
#mtry = number of randomly preselected predictor variables for each split (suggested to do the square-root of the number of variables)
#when using categorical variables, make sure they are encoded as factors
set.seed(47)
partyforest <- cforest(nTrait ~ year + habitat + Total.Number.Species + sys1Grp, 
                       data = mydata, controls=cforest_unbiased(ntree=1000, mtry=3)) #run the random forest

#partyforest.varimp <- varimp(partyforest, conditional = TRUE) #permutation accuracy variable importance... this will take a while
#conditional variable importance reflects the true impact of each predictor variable more reliably than the original marginal approach... this didn't actually run and I got this error code: 'Error in model@fit(data, ...) : error code 1 from Lapack routine 'dgesdd''
partyforest.varimp<- varimp(partyforest)
partyforest.varimp

library(lattice)
dotplot(sort(partyforest.varimp),
        xlab="Variable Importance\n(predictors to right of dashed vertical line are significant)", 
        panel = function(x,y){
          panel.dotplot(x, y, col="darkblue", pch=16, cex=1.1)
          panel.abline(v=abs(min(partyforest.varimp)), 
                       col="red", lty="longdash", lwd=2)
          })
#variables can be considered informative and important if their variable importance value is above the absolute value of the lowest negative-scoring variable.


#same idea, different package. Random Forest model using 'randomForest'
library(randomForest)
rforest<-randomForest(nTrait ~ year + habitat + Total.Number.Species + sys1Grp, data = mydata)
#couldn't include region.ISO3 because it has > 53 categories
dotchart(sort(rforest$importance[,1]), xlab='%IncNodePurity') 
#randomForest and party give the same importance rankings


#Now, use rpart to build just one tree at a time so that you can visualize a tree
library(rpart)
library(partykit)
data.ctree<-rpart(nTrait ~ year + habitat + sys1Grp,
                  data=mydata, control=rpart.control(cp=0.001, minsplit=2))

#look at the full tree
plot(data.ctree)
text(data.ctree)

#look at how the fit changes as the tree grows
printcp(data.ctree)
plotcp(data.ctree)

#decide how many splits to allow
nSplits<-which.min(data.ctree$cptable[,"xerror"]) #choose the number of splits where the cross-validation error is minimized
nSplits<-4 #this is too many splits, but for demonstration purposes...

#prune the tree
pruned.tree <- prune(data.ctree, cp=data.ctree$cptable[nSplits,"CP"])
pruned.tree

#plot
plot(as.party(pruned.tree), tp_args=list(id=F))
```  

_________________________________________________________________
# 1. Accepted studies

Total number of studies
```{r studies1, echo=FALSE, warning=FALSE}
totalNumStudies<-length(unique(Study.Info.Subset.DF$ID))
paste(totalNumStudies, 'accepted studies in the dataset')
```  

Number of studies published last year
```{r studies2,echo=FALSE, warning=FALSE}
summ <- ddply(Study.Info.Subset.DF,~year, summarise, nID=length(unique(ID))) 
numStudies2014<-summ[summ$year==2014,'nID']
perc_2014<-round((numStudies2014/totalNumStudies)*100, digits=2)
paste(perc_2014, "% of studies were published last year")
```

_________________________________________________________________
# 2. Which countries?

What are the top 10 countries producing FD studies?  
```{r countries,echo=FALSE, warning=FALSE}
df.iso<-ExpandMelt(df=Study.Info.Subset.DF, varName='region.ISO3')
summ <- ddply(df.iso,~region.ISO3, summarise, nID=length(unique(ID))) 
summ.o<-orderBy(~-nID, summ)
summ.o1<-summ.o[1:5,] #take only the top 10 countries
positions<-summ.o1$region.ISO3
iso.Plot<-ggplot(summ.o, aes(x=region.ISO3, y=nID)) + 
  geom_bar(stat='identity') + 
  ylab('Count') + xlab('Top 10 Countries') +
  scale_y_continuous(expand=c(0,0)) + scale_x_discrete(limits= positions) + 
  mytheme + theme(axis.text.x = element_text(angle=45, hjust=1))
```  

_________________________________________________________________
# 3. Which ecosystems?

What % of studies include terrestrial systems?
```{r ecosystems1,echo=FALSE, warning=FALSE}
df.sys1<-ExpandMelt(df=Study.Info.Subset.DF, varName='sys1')
summ <- ddply(df.sys1,~ID, summarise, 
              presenceA=sum(sys1=='A'),
              presenceT=sum(sys1=='T')) 
studiesWithA<-sum(summ$presenceA==1)
studiesWithT<-sum(summ$presenceT==1)
totalNumStudies<-length(summ$ID)
studiesWithBoth<-sum(summ$presenceA==1 & summ$presenceT==1)
perc_terrestrial<-round((studiesWithT/totalNumStudies)*100, digits=2)
paste(perc_terrestrial, "% of studies are terrestrial")
```  

What % of studies include terrestrial plants?
```{r ecosystems2,echo=FALSE, warning=FALSE}
summ <- ddply(Study.Info.Subset.DF,~sys1Grp, summarise, nID=length(unique(ID))) 
studiesWithTrPl<-summ[summ$sys1Grp=='terrestrial plant','nID']
perc_TrPl<-round((studiesWithTrPl/totalNumStudies)*100, digits=2)
paste(perc_TrPl, "% of studies are terrestrial plants")
``` 

Do that number of studies that include terrestrial/aquatic systems and plant/animal taxa change over time?
```{r ecosystems3,echo=FALSE, warning=FALSE}
summ.year<-ddply(Study.Info.Subset.DF,~year, summarize,
      AqAn = sum(sys1Grp=='aquatic animal'),
      AqPl = sum(sys1Grp=='aquatic plant'),
      TrAn = sum(sys1Grp=='terrestrial animal'),
      TrPl = sum(sys1Grp=='terrestrial plant'),
      Other = sum(!sys1Grp %in% c('aquatic animal','aquatic plant','terrestrial animal','terrestrial plant')))
summ.year.long<- melt(summ.year, id='year') 
summ.year.long$variable<-factor(summ.year.long$variable, levels=c('TrPl','TrAn','AqPl','AqAn','Other'))
year.Plot<-ggplot(summ.year.long, aes(x=year, y=value, fill=variable)) + 
  geom_bar(stat='identity') + 
  ylab('# of accepted\nstudies') + xlab('Year') +
  scale_y_continuous(expand=c(0,0), limits=c(0,100)) + 
  scale_x_continuous(breaks=seq(1990, 2014, by=2)) +
  mytheme + theme(axis.text.x = element_text(angle=45, hjust=1))+
  scale_fill_manual(name='System and Taxa',
                    labels=c('Terrestrial plant','Terrestrial animal',
                             'Aquatic plant','Aquatic animal','Other'),
                    values=c('#008000','#329932',
                             '#1F497D','#4b6d97','#D72027'))
filename<-"plot_year.png"
mypath<-file.path("/Users/mrl17/Desktop/Figures_ESA2015", "figures", filename)
png(mypath, units='in', width = 5.5, height = 4, res=300)
year.Plot
dev.off()
``` 
![alt text](figures/plot_year.png)

Rank the frequency that each ecosystem type was present. 
Color by manually assigning terrestrial/aquatic system.
```{r ecosystems4,echo=FALSE, warning=FALSE}
df.habitat<-ExpandMelt(df=Study.Info.Subset.DF, varName='habitat')
unique(df.habitat$habitat)
summ <- ddply(df.habitat,~ID, summarise, 
              TAIG=sum(habitat=='TAIG'),
              TROP=sum(habitat=='TROP'),
              TEMP=sum(habitat=='TEMP'),
              GRAS=sum(habitat=='GRAS'),
              RIPA=sum(habitat=='RIPA'),
              NEAR=sum(habitat=='NEAR'),
              AGRI=sum(habitat=='AGRI'),
              LAKE=sum(habitat=='LAKE'),
              TUND=sum(habitat=='TUND'),
              PELA=sum(habitat=='PELA'),
              DESE=sum(habitat=='DESE'))
numStudiesPresent<-apply(summ, 2, sum)[-1]
habitatName<-names(numStudiesPresent)
prettyNames<-c('Taiga','Tropical forest','Temperate forest',
               'Grassland','Riparian','Coastal','Agriculture',
               'Lake','Tundra','Marine pelagic','Desert')
summ.habitat<-data.frame(habitatName, numStudiesPresent, prettyNames)

#define sys1 manually for each habitat
aquaticEco<-c('Riparian','Coastal','Freshwater','Marine pelagic')
summ.habitat$sys1.manual<-'Terrestrial'
summ.habitat[summ.habitat$prettyNames %in% aquaticEco,'sys1.manual']<-'Aquatic'
summ.habitat$sys1.manual<-factor(summ.habitat$sys1.manual, levels=c('Terrestrial','Aquatic'))
summ.habitat.o<-orderBy(~sys1.manual-numStudiesPresent, summ.habitat)

#plot
positions<-summ.habitat.o$prettyNames
habitat.Plot<-ggplot(summ.habitat.o, aes(x=prettyNames, y=numStudiesPresent, fill=sys1.manual)) + 
  geom_bar(stat='identity') + 
  ylab('# of studies') + xlab('Ecosystem') +
  scale_y_continuous(expand=c(0,0), limits=c(0,40)) + 
  scale_x_discrete(limits= positions) + 
  mytheme + theme(axis.text.x = element_text(angle=45, hjust=1)) +
  scale_fill_manual(name='System',
                    label=c('Terrestrial','Aquatic'),
                    values=c('#008000','#1F497D'))

#save plot
filename<-"plot_ecosystem.png"
mypath<-file.path("/Users/mrl17/Desktop/Figures_ESA2015", "figures", filename)
png(mypath, units='in', width = 5.5, height = 4, res=300)
habitat.Plot
dev.off()
```  
![alt text](figures/plot_ecosystem.png)

Rank the frequency that each ecosystem type was present. 
Color by terrestrial/aquatic system and plant/animal taxa.
```{r ecosystems5,echo=FALSE, warning=FALSE}
summ1<-merge(summ, id_sys1Grp, by="ID")
summ.sys1Grp<-ddply(summ1,~sys1Grp, summarize,
                    TAIG=sum(TAIG==1),
                    TROP=sum(TROP==1),
                    TEMP=sum(TEMP==1),
                    GRAS=sum(GRAS==1),
                    RIPA=sum(RIPA==1),
                    NEAR=sum(NEAR==1),
                    AGRI=sum(AGRI==1),
                    LAKE=sum(LAKE==1),
                    TUND=sum(TUND==1),
                    PELA=sum(PELA==1),
                    DESE=sum(DESE==1))
summ1.long<- melt(summ.sys1Grp, id=c('sys1Grp'))
setnames(summ1.long, 'variable', 'habCode')
habCode<-summ.habitat.o$habitatName
habName<-summ.habitat.o$prettyNames
habindex<-data.frame(habCode, habName)
summ1.long<-merge(summ1.long, habindex)

#plot
habitat2.Plot<-ggplot(summ1.long, aes(x=habName, y=value, fill=sys1Grp)) + 
  geom_bar(stat='identity') + 
  scale_y_continuous(expand=c(0,0), limits=c(0,40)) + 
  ylab('# of studies') + xlab('Ecosystem') + scale_x_discrete(limits= positions) + 
  mytheme + theme(axis.text.x = element_text(angle=45, hjust=1)) +
  scale_fill_manual(name='System and Taxa',
                    labels=c('Terrestrial plant','Terrestrial animal',
                             'Aquatic plant','Aquatic animal','Other'),
                    values=c('#008000','#329932',
                             '#1F497D','#4b6d97','#D72027'))

#why are there terrestrial plant and animals in NEAR and LAKE habitats?
odd.near<-subset(summ1, NEAR==1 & sys1Grp %in% c('terrestrial plant','terrestrial animal'))
odd.lake<-subset(summ1, LAKE==1 & sys1Grp %in% c('terrestrial plant','terrestrial animal'))
odd<-rbind(odd.near, odd.lake)
paste('IDs that need their group checked =',paste(odd$ID,collapse=', '))
```

What % of studies include grassland ecosystems?
```{r ecosystems6,echo=FALSE, warning=FALSE}
perc_grassland<-round((summ.habitat[summ.habitat$habitatName=='GRAS','numStudiesPresent']/totalNumStudies)*100, digits=2)
paste(perc_grassland, "% of studies are in grasslands")
```

_________________________________________________________________
# 4. Which taxa? How many?

Which taxa have been most frequently studied?  
```{r taxa1,echo=FALSE, warning=FALSE, message=FALSE}
df.subgroup<-ExpandMelt(df=Study.Info.Subset.DF, varName='sub.group')
#unique(df.subgroup$sub.group)
#unique(df.subgroup$sys1)        
summ <- ddply(df.subgroup,~sys1+ID, summarise, 
              shrubs=sum(sub.group=='shrubs'),
              invertebrates=sum(sub.group=='invertebrates'),
              vertebrates=sum(sub.group=='vertebrates'),
              trees=sum(sub.group=='trees'),
              graminoids=sum(sub.group=='graminoids'),
              forbs=sum(sub.group=='forbs'),
              algae=sum(sub.group=='algae'),
              nonvascular=sum(sub.group=='nonvascular'),
              fungi=sum(sub.group=='fungi'),
              diatoms=sum(sub.group=='diatoms'),
              microbemix=sum(sub.group=='microbemix'))
summ2<-ddply(summ, ~sys1, summarize,
             Nshrubs=sum(shrubs==1),
             Ninvertebrates=sum(invertebrates==1),
             Nvertebrates=sum(vertebrates==1),
             Ntrees=sum(trees==1),
             Ngraminoids=sum(graminoids==1),
             Nforbs=sum(forbs==1),
             Nalgae=sum(algae==1),
             Nnonvascular=sum(nonvascular==1),
             Nfungi=sum(fungi==1),
             Ndiatoms=sum(diatoms==1),
             Nmicrobemix=sum(microbemix==1))
summ2.melted<- melt(summ2, id=c('sys1')) 
setnames(summ2.melted, 'value','numStudiesPresent')
prettyNames<-c('Shrub','Invertebrate','Vertebrate',
               'Tree','Graminoid','Forb','Algae',
               'Nonvascular','Fungus','Diatom','Microbe mix')
sub.groupName<-rep(prettyNames, each=length(unique(df.subgroup$sys1)))
summ.subgroup<-data.frame(summ2.melted,sub.groupName)

#identify the group to which each sub.group belongs
summ.subgroup$group.manual<-NA
plantGroup<-c('Algae','Tree','Shrub','Graminoid','Forb','Nonvascular')
microbeGroup<-c('Microbe mix','Bacteria','Diatom','Fungus','Bacterioplankton')
animalGroup<-c('Vertebrate','Invertebrate')
summ.subgroup[summ.subgroup$sub.groupName %in% plantGroup,'group.manual']<-'plants'
summ.subgroup[summ.subgroup$sub.groupName %in% microbeGroup,'group.manual']<-'microbes'
summ.subgroup[summ.subgroup$sub.groupName %in% animalGroup,'group.manual']<-'animals'

#replace 'animals' with animal.groups
summ.subgroup<-summ.subgroup[summ.subgroup$group.manual !='animals',] #remove animals from current 
df.animalgroup<-ExpandMelt(df=Study.Info.Subset.DF, varName='animal.group') #count number of animal studies
#unique(df.animalgroup$animal.group)
summ <- ddply(df.animalgroup,~sys1+ID, summarise, 
              arthropods=sum(animal.group=='arthropods'),
              birds=sum(animal.group=='birds'),
              mammals=sum(animal.group=='mammals'),
              fish=sum(animal.group=='fish'),
              herps=sum(animal.group=='herps'),
              mollusks=sum(animal.group=='mollusks'),
              annelids=sum(animal.group=='annelids'))
summ2<-ddply(summ, ~sys1, summarize,
             Narthropods=sum(arthropods==1),
             Nbirds=sum(birds==1),
             Nmammals=sum(mammals==1),
             Nfish=sum(fish==1),
             Nherps=sum(herps==1),
             Nmollusks=sum(mollusks==1),
             Nannelids=sum(annelids==1))
summ2.melted<- melt(summ2, id=c('sys1')) 
setnames(summ2.melted, 'value','numStudiesPresent')
prettyNames<-c('Arthropod','Bird','Mammal','Fish','Herp','Mollusk','Annelid')
sub.groupName<-rep(prettyNames, each=length(unique(df.subgroup$sys1)))
summ.animalgroup<-data.frame(summ2.melted,sub.groupName)

#identify the vert/invert to which each animal.group belongs
summ.animalgroup$group.manual<-NA
vertGroup<-c('Bird','Mammal','Fish','Herp')
invertGroup<-c('Arthropod','Mollusk','Annelid')
summ.animalgroup[summ.animalgroup$sub.groupName %in% vertGroup,'group.manual']<-'vertebrates'
summ.animalgroup[summ.animalgroup$sub.groupName %in% invertGroup,'group.manual']<-'invertebrates'

#merge summ.subgroup and summ.animalgroup
#colnames(summ.subgroup); colnames(summ.animalgroup)
summ<-rbind(summ.subgroup, summ.animalgroup)
summ$group.manual<-factor(summ$group.manual, levels = c('plants','invertebrates','vertebrates','microbes'))
summ.o<-orderBy(~group.manual-numStudiesPresent, summ)
positionsGRP<-list(plants=c('Forb','Graminoid','Shrub','Tree','Nonvascular','Algae'),
                   inverts=c('Arthropod','Mollusk','Annelid'),
                   verts=c('Fish','Bird','Mammal','Herp'),
                   microbes=c('Microbe mix','Fungus','Diatom'))

#plot
GRP<-unique(summ.o$group.manual)
subgroup.Plots<-list()
i<-0
for(i in 1:length(GRP)){
  sub.df<-subset(summ.o, group.manual==GRP[i])
  positions<-positionsGRP[[i]]
  subgroup.Plots[[i]]<-ggplot(sub.df, aes(x=sub.groupName, 
                                          y=numStudiesPresent, 
                                          fill=sys1)) + 
    geom_bar(stat='identity') + 
    ylab('# of studies') + xlab('') +
    scale_y_continuous(expand=c(0,0)) + scale_x_discrete(limits= positions) +
    scale_fill_manual(name='System',
                    labels=c('Aquatic','Terrestrial','Both'),
                    values=c('#1F497D','#008000','#D72027')) +
    guides(fill=FALSE)+
    mytheme + theme(axis.text.x = element_text(angle=45, hjust=1))
}
names(subgroup.Plots)<-GRP

filename<-"plot_subGroup_plants.png"
mypath<-file.path("/Users/mrl17/Desktop/Figures_ESA2015", "figures", filename)
png(mypath, units='in', width = 5.5, height = 4, res=300)
subgroup.Plots[['plants']]+ggtitle('Plants')+scale_y_continuous(expand=c(0,0), limits=c(0,65))
dev.off()

filename<-"plot_subGroup_microbes.png"
mypath<-file.path("/Users/mrl17/Desktop/Figures_ESA2015", "figures", filename)
png(mypath, units='in', width = 3, height = 4, res=300)
subgroup.Plots[['microbes']]+ggtitle('Microbes')+scale_y_continuous(expand=c(0,0), limits=c(0,2.1))
dev.off()

filename<-"plot_subGroup_invertebrates.png"
mypath<-file.path("/Users/mrl17/Desktop/Figures_ESA2015", "figures", filename)
png(mypath, units='in', width = 3, height = 4, res=300)
subgroup.Plots[['invertebrates']]+ggtitle('Invertebrates')+scale_y_continuous(expand=c(0,0), limits=c(0,18))
dev.off()

filename<-"plot_subGroup_vertebrates.png"
mypath<-file.path("/Users/mrl17/Desktop/Figures_ESA2015", "figures", filename)
png(mypath, units='in', width = 4, height = 4, res=300)
subgroup.Plots[['vertebrates']]+ggtitle('Vertebrates')+scale_y_continuous(expand=c(0,0), limits=c(0,12))
dev.off()
```  
![alt text](figures/plot_subGroup_plants.png)
![alt text](figures/plot_subGroup_microbes.png)
![alt text](figures/plot_subGroup_invertebrates.png)
![alt text](figures/plot_subGroup_vertebrates.png)

How many species?
Facet by terrestrial/aquatic system and plant/animal taxa.
```{r taxa2,echo=FALSE, warning=FALSE}
#prep column
Study.Info.Subset.DF$Total.Number.Species<-as.character(Study.Info.Subset.DF$Total.Number.Species)
Study.Info.Subset.DF$Total.Number.Species<-as.numeric(Study.Info.Subset.DF$Total.Number.Species) #ok - these 
#order data and remove outliers
df.o<-orderBy(~-Total.Number.Species, Study.Info.Subset.DF)
outliers<-df.o[1:2,'Total.Number.Species'] #there are 2 crazy outliers with >1000 species
temp.df<-df.o[df.o$Total.Number.Species <1000 & !is.na(df.o$Total.Number.Species),]

#calc medians
summ.numSp <- ddply(temp.df,~sys1Grp, summarise,
                    n=length(unique(ID)),
                    med=median(Total.Number.Species, na.rm=T),
                    min=min(Total.Number.Species, na.rm=T),
                    max=max(Total.Number.Species, na.rm=T))
summ.numSp
medianSp<-median(temp.df$Total.Number.Species, na.rm = T)
paste('Median =', medianSp)

#hist colored by system and taxa
temp.df1<-subset(temp.df, sys1Grp != 'other')
numSpecies.Plot<-ggplot(temp.df1, aes(x = Total.Number.Species, fill=sys1Grp))+
  geom_histogram(binwidth=50)+
  facet_wrap(~sys1Grp, ncol=2, scales='free_y')+
  xlab("# of species per study")+
  ylab("# of studies") + mytheme +
  geom_vline(xintercept=medianSp, col=1, linetype=2) +
  scale_x_continuous(expand = c(0,0), limits=c(0,1010)) +
  scale_y_continuous(expand = c(0,0)) +
  scale_fill_manual(name='System and Taxa',
                    labels=c('Terrestrial plant','Terrestrial animal',
                             'Aquatic plant','Aquatic animal','Other'),
                    values=c('#008000','#329932',
                             '#1F497D','#4b6d97','#D72027'))
filename<-"plot_numSp_facet.png"
mypath<-file.path("/Users/mrl17/Desktop/Figures_ESA2015", "figures", filename)
png(mypath, units='in', width = 9, height = 6, res=300)
numSpecies.Plot
dev.off()
```  
![alt text](figures/plot_numSp.png)

_________________________________________________________________
# 5. Which traits? How many?

Prep data by merging the FDtraits df with the FDmetricDetails df
```{r traits_prep,echo=FALSE, warning=FALSE}
df.trait.annotated<-merge(Study.Info.Subset.DF, Trait.Info.Subset.DF, by="ID", all.x=TRUE) #this should have the same number of rows

# #summarize by sys1
# summ.tr <- ddply(df.trait.annotated,~sys1+Trait.Category.New+Trait.Name, summarise, 
#                    nID=length(unique(ID)))
# summ.tr
```  

Traits were classified into 14 trait categories that generalize ways in which a trait might describe the functioning of an organism in an ecosystem.  For each trait category, how many studies incorporated traits characteristic of that category into an measure of functional diversity?
```{r traits2,echo=FALSE, warning=FALSE}
trCatcode<-paste('cat', seq(1:15), sep="")
trCatIndex<-data.frame(trCatcode, trCat=unique(df.trait.annotated$Trait.Category.New))
trCatIndex
summ <- ddply(df.trait.annotated,~ID, summarise, 
              cat1=sum(Trait.Category.New==trCatIndex[1,'trCat']),
              cat2=sum(Trait.Category.New==trCatIndex[2,'trCat']),
              cat3=sum(Trait.Category.New==trCatIndex[3,'trCat']),
              cat4=sum(Trait.Category.New==trCatIndex[4,'trCat']),
              cat5=sum(Trait.Category.New==trCatIndex[5,'trCat']),
              cat6=sum(Trait.Category.New==trCatIndex[6,'trCat']),
              cat7=sum(Trait.Category.New==trCatIndex[7,'trCat']),
              cat8=sum(Trait.Category.New==trCatIndex[8,'trCat']),
              cat9=sum(Trait.Category.New==trCatIndex[9,'trCat']),
              cat10=sum(Trait.Category.New==trCatIndex[10,'trCat']),
              cat11=sum(Trait.Category.New==trCatIndex[11,'trCat']),
              cat12=sum(Trait.Category.New==trCatIndex[12,'trCat']),
              cat13=sum(Trait.Category.New==trCatIndex[13,'trCat']),
              cat14=sum(Trait.Category.New==trCatIndex[14,'trCat']),
              cat15=sum(Trait.Category.New==trCatIndex[15,'trCat'])
              )
summ1<-melt(summ, id.vars = 'ID')
setnames(summ1, 'variable','trCatcode')
setnames(summ1, 'value','numTr')
summ1$catPresent<-summ1$numTr !=0
summ2<-merge(summ1, trCatIndex, by='trCatcode')
summ3<-ddply(summ2, ~trCat, summarize, nID=length(catPresent[catPresent=='TRUE']))
summ3.o<-orderBy(~-nID, summ3)
positions<-summ3.o$trCat

#plot
traitCat.Plot<-ggplot(summ3.o, aes(x=trCat, y=nID)) + 
  geom_bar(stat='identity') + 
  ylab('# of studies') + xlab('Trait category') +
  scale_y_continuous(expand=c(0,0)) + scale_x_discrete(limits= positions) + 
  mytheme + theme(axis.text.x = element_text(angle=45, hjust=1))
```  

By terrestrial/aquatic system and plant/animal taxa, how many studies incorporated traits characteristic of that category into an measure of functional diversity?
```{r traits3,echo=FALSE, warning=FALSE}
summ2.1<-merge(summ2, id_sys1Grp)
summ3.1<-ddply(summ2.1, ~sys1Grp+trCat, summarize,
             nID=length(catPresent[catPresent=='TRUE']))
summ3.1.o<-orderBy(~sys1Grp-nID, summ3.1)
summ3.1.o$trCat<-factor(summ3.1.o$trCat, levels=positions)

#plot
traitCat.Plot<-ggplot(summ3.1.o, aes(x=trCat, y=nID, fill=sys1Grp)) + 
  geom_bar(stat='identity') +
  ylab('# of studies') + xlab('Trait category') +
  scale_y_continuous(expand=c(0,0)) +mytheme + theme(axis.text.x = element_text(angle=45, hjust=1))+
  scale_fill_manual(name='System and Taxa',
                    labels=c('Terrestrial plant','Terrestrial animal',
                             'Aquatic plant','Aquatic animal','Other'),
                    values=c('#008000','#329932',
                             '#1F497D','#4b6d97','#D72027'))

#plot in facets
summ3.1.o.1<-subset(summ3.1.o, sys1Grp != 'other')
traitCat.Plot2<-ggplot(summ3.1.o.1, aes(x=trCat, y=nID, fill=sys1Grp)) + 
  geom_bar(stat='identity') + facet_wrap(~sys1Grp, ncol=2, scale='free_y')+
  ylab('# of studies') + xlab('Trait category') +
  scale_y_continuous(expand=c(0,0)) +mytheme + theme(axis.text.x = element_text(angle=45, hjust=1))+
  scale_fill_manual(name='System and Taxa',
                    labels=c('Terrestrial plant','Terrestrial animal',
                             'Aquatic plant','Aquatic animal','Other'),
                    values=c('#008000','#329932',
                             '#1F497D','#4b6d97','#D72027'))
filename<-"plot_traitCat_facets.png"
mypath<-file.path("/Users/mrl17/Desktop/Figures_ESA2015", "figures", filename)
png(mypath, units='in', width = 8, height = 6, res=300)
traitCat.Plot2 + guides(fill=FALSE) 
dev.off()
```  
![alt text](figures/plot_traitCat_facets.png)

Which traits were most frequently used within each trait category?  
```{r traits4,echo=FALSE, warning=FALSE}
summ <- ddply(Trait.Info.Subset.DF,~Trait.Category.New+Trait.Name, summarise, 
              nID=length(unique(ID)))
summ.o<-orderBy(~-nID, summ)
summ.o1<-summ.o[summ.o$nID >= 5,] #only include traits that show up in 5 or more studies

#plot
CAT<-unique(summ.o1$Trait.Category.New)
trait.Plots<-list()
i<-0
for(i in 1:length(CAT)){
  tmp.df<-subset(summ.o1, Trait.Category.New == CAT[i])
  positions<-tmp.df$Trait.Name
  trait.Plots[[i]]<-ggplot(tmp.df, aes(x=Trait.Name, y=nID)) + geom_bar(stat='identity') + 
    ylab('# of studies') + xlab('Trait name') +
    scale_y_continuous(expand=c(0,0)) + scale_x_discrete(limits= positions) + 
    mytheme + theme(axis.text.x = element_text(angle=45, hjust=1)) + ggtitle(CAT[i])
}
names(trait.Plots)<-CAT

trait.Plots[['growth allocation']] + ggtitle('Growth allocation')
trait.Plots[['body size']] + ggtitle('Body size')
trait.Plots[['resource use']] + ggtitle('Resource use')
trait.Plots[['reproduction']] + ggtitle('Reproduction')
trait.Plots[['temporal partitioning']]
trait.Plots[['unclassified']]

#habitat trait examples
justHabitat<-summ[summ$Trait.Category.New=='habitat',]
justHabitat.o<-orderBy(~-nID, justHabitat)
justHabitat.o[1:10,'Trait.Name']
``` 

How many traits?  
```{r traits5,echo=FALSE, warning=FALSE}
summ.ID <- ddply(Trait.Info.Subset.DF,~ID, summarise, 
              nTrait=length(unique(Trait.Name)),
              nTraitCat=length(unique(Trait.Category.New)),
              nTraitSource=length(unique(Trait.Source)),
              nameSource=paste(unique(Trait.Source), collapse = "_")) 
summ1<-merge(summ.ID, id_sys1Grp, by="ID")

#plot
medianTr<-median(summ1$nTrait, na.rm=T)
ddply(summ1, ~sys1Grp, summarize, med=median(nTrait, na.rm=T))
paste('Median =',medianTr)
summ1.1<-subset(summ1, sys1Grp != 'other')
numTraits.Plot<-ggplot(summ1.1, aes(x =nTrait, fill=sys1Grp))+
  geom_histogram(binwidth=1)+xlab("# of traits per study")+ 
  facet_wrap(~sys1Grp, ncol=2, scales='free_y') +
  scale_x_continuous(expand = c(0,0), limits=c(1,50), breaks=c(0,2,5,7,10, 20, 30, 40, 50)) +
  scale_y_continuous(expand = c(0,0)) +
  ylab("Count")+ mytheme +
  geom_vline(xintercept=medianTr, col=1, linetype=2)+
  scale_fill_manual(name='System and Taxa',
                    labels=c('Terrestrial plant','Terrestrial animal',
                             'Aquatic plant','Aquatic animal','Other'),
                    values=c('#008000','#329932',
                             '#1F497D','#4b6d97','#D72027'))
filename<-"plot_numTr.png"
mypath<-file.path("/Users/mrl17/Desktop/Figures_ESA2015", "figures", filename)
png(mypath, units='in', width = 9, height = 6, res=300)
numTraits.Plot
dev.off()
```  
![alt text](figures/plot_numTr.png)

How many trait categories?  
```{r traits6,echo=FALSE, warning=FALSE}
medianTrCat<-median(summ.ID$nTraitCat, na.rm=T)
numTraitCats.Plot<-ggplot(summ.ID, aes(x =nTraitCat))+
  geom_histogram(binwidth=1)+xlab("# of trait categories per study")+
  scale_x_continuous(expand = c(0,0), breaks=c(1:10), limits=c(1,11)) +
  scale_y_continuous(expand = c(0,0)) +
  ylab("Count") + mytheme +
  geom_vline(xintercept=medianTrCat, col=1, linetype=2)

paste('Median =',medianTrCat)
``` 

Rank the frequency that each trait source was used.  
Trait source categories include: within-study measurement, literature, database. 
```{r traits7,echo=FALSE, warning=FALSE}
df.trsource<-ExpandMelt(df=Trait.Info.Subset.DF, varName='Trait.Source')
summ <- ddply(df.trsource,~ID, summarise, 
              nSources=length(unique(Trait.Source)),
              nameSource=paste(unique(Trait.Source),collapse="_"),
              nMeas=length(unique(Trait.Source[Trait.Source==1])),
              nDatab=length(unique(Trait.Source[Trait.Source==2])),
              nLit=length(unique(Trait.Source[Trait.Source==3])))
summ1<-summ[,c('ID','nMeas','nDatab','nLit')]
summ1m<-melt(summ1, id.vars='ID')
summ2 <- ddply(summ1m,~variable, summarise, nID=length(value[value==1]))
summ2$prettyNames<-c('Measurement','Trait database','Literature')
summ.o<-orderBy(~-nID, summ2)
positions<-summ.o$prettyNames

#plot
trsource.Plot<-ggplot(summ.o, aes(x=prettyNames, y=nID)) + 
  geom_bar(stat='identity') + 
  ylab('# of studies') + xlab('Trait source') +
  scale_y_continuous(expand=c(0,0), limits=c(0,100)) + scale_x_discrete(limits= positions) + 
  mytheme + theme(axis.text.x = element_text(angle=45, hjust=1))
filename<-"plot_TrSource.png"
mypath<-file.path("/Users/mrl17/Desktop/Figures_ESA2015", "figures", filename)
png(mypath, units='in', width = 2, height = 3, res=300)
trsource.Plot
dev.off()
```  
![alt text](figures/plot_TrSource.png)

What % of studies measure (at least some) of their own traits?
What % of studies use trait databases?
```{r traits8,echo=FALSE, warning=FALSE}
numStudies<-length(summ$ID)
nMeas<-summ.o[summ.o$variable=='nMeas', 'nID']
nDatab<-summ.o[summ.o$variable=='nDatab', 'nID']
percMeas<-round((nMeas/numStudies)*100, digits=0)
percDatab<-round((nDatab/numStudies)*100, digits=0) 
paste(percMeas,'% of studies that measure traits')
paste(percDatab,'% of studies that use a trait database')
```  

Do terrestrial/aquatic systems and plant/animal taxa rely on different trait sources?
```{r traits9,echo=FALSE, warning=FALSE}
df.trsource2<-merge(df.trsource, id_sys1Grp, by="ID")
summ1 <- ddply(df.trsource2,~sys1Grp+Trait.Source, summarise, nID=length(unique(ID))) 
Trait.Source<-unique(summ1$Trait.Source)
trSourceName<-prettynames<-c('Measurement','Trait database','Literature', 'Other')
trSourceIndex<-data.frame(Trait.Source,trSourceName)
summ2<-merge(summ1, trSourceIndex, by='Trait.Source')
summ2.o<-orderBy(~sys1Grp+Trait.Source, summ2)

#plot
summ2.o.1<-subset(summ2.o, sys1Grp != 'other')
trsource.Plot2<-ggplot(summ2.o.1, aes(x=trSourceName, y=nID, fill=sys1Grp)) + 
  geom_bar(stat='identity') + facet_wrap(~sys1Grp, ncol=2, scales="free_y")+
  ylab('# of studies') + xlab('Trait source') +
  scale_y_continuous(expand=c(0,0)) +  scale_x_discrete(limits= positions) +
  mytheme + theme(axis.text.x = element_text(angle=45, hjust=1))+
  scale_fill_manual(name='System and Taxa',
                    labels=c('Terrestrial plant','Terrestrial animal',
                             'Aquatic plant','Aquatic animal','Other'),
                    values=c('#008000','#329932',
                             '#1F497D','#4b6d97','#D72027'))
filename<-"plot_TrSource_facet.png"
mypath<-file.path("/Users/mrl17/Desktop/Figures_ESA2015", "figures", filename)
png(mypath, units='in', width = 9, height = 6, res=300)
trsource.Plot2
dev.off()
  
#calc % of studies by taxa that measure vs. use trait databases
summ2.o.TrPl<-subset(summ2.o, sys1Grp=='terrestrial animal')
total<-sum(summ2.o.TrPl$nID)
nMeas<-summ2.o.TrPl[summ2.o.TrPl$Trait.Source==1,'nID']
nLit<-summ2.o.TrPl[summ2.o.TrPl$Trait.Source==2,'nID']
nDatab<-summ2.o.TrPl[summ2.o.TrPl$Trait.Source==3,'nID']
percMeas<-(nMeas/total)*100
percLit<-(nLit/total)*100
percDatab<-(nDatab/total)*100
```  
![alt text](figures/plot_TrSource_facet.png)

What % of studies use >1 trait source?
```{r traits10,echo=FALSE, warning=FALSE}
summ.ID <- ddply(Trait.Info.Subset.DF,~ID, summarise, 
              nTraitSource=length(unique(Trait.Source)),
              nameSource=paste(unique(Trait.Source), collapse = "_")) 
summ1<-merge(summ.ID, id_sys1Grp, by="ID")
total<-length(summ.ID$nTraitSource)
selection<-sum(summ.ID$nTraitSource > 1)
perc_1TrS<-round((selection/total)*100, digits=2)
paste(perc_1TrS,'% of studies use more than 1 trait source')
```  

Of the studies that only use 1 source, what source is most common?
```{r traits11,echo=FALSE, warning=FALSE}
summ.ID.1trS<-summ.ID[summ.ID$nTraitSource==1,]
summ.ID.1trS1<-ddply(summ.ID.1trS, ~nameSource, summarize, nSource=length(unique(ID)))
numStudies1<-sum(summ.ID$nTraitSource == 1)
nMeas<-summ.ID.1trS1[summ.ID.1trS1$nameSource=='1','nSource']
nDatab<-summ.ID.1trS1[summ.ID.1trS1$nameSource=='3','nSource']
percMeas<-round((nMeas/numStudies1)*100, digits=0)
percDatab<-round((nDatab/numStudies1)*100, digits=0) 
paste(percMeas,'% of studies that use 1 trait souce measure their own traits')
paste(percDatab,'% of studies that use 1 trait souce use a trait database')
```  

Have the use of trait sources changed over time?  
```{r traits12,echo=FALSE, warning=FALSE}
id_year<-Study.Info.Subset.DF[,c('ID','year')]
df.trsource3<-merge(df.trsource, id_year, by="ID")
summ3 <- ddply(df.trsource3,~year+Trait.Source, summarise, nID=length(unique(ID))) 
summ3<-merge(summ3, trSourceIndex, by='Trait.Source')
summ3.o<-orderBy(~year+Trait.Source, summ3)
summ4<-dcast(summ3.o, year~Trait.Source+trSourceName, value.var = 'nID')
summ4$nID<-apply(summ4[,-1], 1, sum, na.rm=T)
summ4$percMeas<-(summ4[,'1_Measurement']/summ4$nID)*100
summ4$percDatab<-(summ4[,'2_Trait database']/summ4$nID)*100
summ4s<-subset(summ4, nID >2)
summ5<-summ4s[,c('year','percMeas','percDatab')]
summ6<-melt(summ5, measure.vars = c('percMeas','percDatab'))

#plot
trsource.Plot3<-ggplot(summ6, aes(x=year, y=value, fill=variable)) + 
  geom_bar(stat='identity', position='dodge') + 
  ylab('% of studies') + xlab('Year') +
  scale_y_continuous(expand=c(0,0), limits=c(0,70)) +
  scale_x_continuous(limits=c(2005,2015), breaks=c(2006, 2008, 2010, 2012, 2014)) +
  mytheme + theme(axis.text.x = element_text(angle=45, hjust=1)) +
  scale_fill_manual(name='Trait source',
                    labels=c('Measurement',
                             'Database'),
                    values=c('#1F497D','#D72027'))
filename<-"plot_TrSource_yr.png"
mypath<-file.path("/Users/mrl17/Desktop/Figures_ESA2015", "figures", filename)
png(mypath, units='in', width = 4, height = 2.5, res=300)
trsource.Plot3
dev.off()
```  
![alt text](figures/plot_TrSource_yr.png)
_________________________________________________________________
# 6. Which diversity metrics? How many?

Prep data by merging the FDmetric-expanded StudyInfo df with the FDmetricDetails df.
```{r metrics_prep,echo=FALSE, warning=FALSE}
df.metric<-ExpandMelt(df=Study.Info.Subset.DF, varName='multivar.FD.Measure')

#simplify FD multivar metrics by removing 'ses' from the front of those codes
df.metric<-data.frame(df.metric)
df.metric$multivar.FD.Measure<-as.character(df.metric$multivar.FD.Measure)
ses.multivar<-df.metric[grepl('ses', df.metric$multivar.FD.Measure),'multivar.FD.Measure']
updated.multivar<-ldply(strsplit(ses.multivar, 'ses'))[,2]
df.metric[grepl('ses', df.metric$multivar.FD.Measure),'multivar.FD.Measure']<-updated.multivar

#summarize df.metric
simp<-ddply(df.metric,~ID, summarise, 
            nCode=length(unique(multivar.FD.Measure)), 
            nCode2=length(multivar.FD.Measure)) #make sure there aren't any duplicate codes for an ID now
sum(simp$nCode != simp$nCode2) #if this is not 0, then there are duplicates

#merge df.metric and FD.Metrics.Subset.DF by multivar.FD.Measure
setnames(df.metric, 'multivar.FD.Measure','code')
FD.Metrics.Subset.DF$code<-as.character(FD.Metrics.Subset.DF$code)
u.codes<-unique(df.metric$code)
lookup.codes<-unique(FD.Metrics.Subset.DF$code)
u.codes[!u.codes %in% lookup.codes] #these codes are missing from the FD metric lookup table
df.metric.annotated<-merge(df.metric, FD.Metrics.Subset.DF, by="code", all.x=TRUE) #this should have the same number of rows as df.metric
df.metric.annotated$CAT_abundance<-droplevels(df.metric.annotated$CAT_abundance)
df.metric.annotated$CAT_dimension<-droplevels(df.metric.annotated$CAT_dimension)
```  

Summarize data by ID and FD metric 
```{r metrics_prep2,echo=FALSE, warning=FALSE}
#by ID
totCode<-length(unique(df.metric.annotated$code))
totDim<-length(unique(df.metric.annotated$CAT_dimension))
totMeth<-length(unique(df.metric.annotated$CAT_multivarMethod))
summ.ID<-ddply(df.metric.annotated, ~ID, summarize,
               nCode=length(unique(code)),
               nDim=length(unique(CAT_dimension)),
               nMeth=length(unique(CAT_multivarMethod)))
summ.ID<-merge(summ.ID, id_sys1Grp, by="ID")

#by code
summ.code <- ddply(df.metric.annotated,~code, summarise, 
                   nID=length(unique(ID)), 
                   Dim=unique(CAT_dimension), 
                   Meth=unique(CAT_multivarMethod), 
                   Abund=unique(CAT_abundance),
                   minYear = min(year, na.rm=T))
summ.code.o<-orderBy(~-nID, summ.code)
summ.code.o1<-summ.code.o[which(summ.code.o$nID >9),]
```  

What % of studies use at least 1 of the top 6 FD metrics
```{r metrics1,echo=FALSE, warning=FALSE}
df.metric.annotated$top6present<-'no' #mark the row if it has a Top6 code
df.metric.annotated[df.metric.annotated$code %in% c('Rao','FRic','FEve','FDis','FDiv', 'FD'),'top6present']<-'yes'
summ.codePresence<-ddply(df.metric.annotated, ~ID, summarize, #summarize by ID
               nCodes=length(unique(code)),
               nameCodes=paste(unique(code), collapse='_'),
               nTop6=length(top6present[top6present=='yes']),
               presTop6=nTop6!=0,
               nRao=length(code[code=='Rao']),
               nFRic=length(code[code=='FRic']),
               nFEve=length(code[code=='FEve']),
               nFDis=length(code[code=='FDis']),
               nFDiv=length(code[code=='FDiv']),
               nFD=length(code[code=='FD']))
selection<-sum(summ.codePresence$presTop6 == TRUE) #count the number of IDs
totalNumStudies<-length(summ.codePresence$presTop6) #count the number of IDs
percTop6<-round((selection/totalNumStudies)*100, digits=2)
paste(percTop6,'% of studies use at least 1 of the top 6 metrics')
```  

What % of studies use each of the top 6 FD metrics?
```{r metrics2,echo=FALSE, warning=FALSE}
TOP6<-c('nRao','nFRic','nFEve','nFDis','nFDiv','nFD')
store<-list()
i<-0
for(i in 1:length(TOP6)){
  selection<-sum(summ.codePresence[,TOP6[i]]) #count the number of ID
  perc<-round((selection/totalNumStudies)*100, digits=0)
  store[[i]]<-paste(perc,'% of studies use', TOP6[i])
}
store
```  

What is the relationship between the frequency each metric is used and its appearance in the literature?
```{r metrics3,echo=FALSE, warning=FALSE}
codeFreq.Plot<-ggplot(summ.code.o, aes(x=minYear, y=nID, label=code))+
  geom_point(subset = .(nID <= 9), position='jitter') + 
  geom_text(aes(label=ifelse(nID>9, code,'')), hjust=-0.2, vjust=0) + geom_point(subset = .(nID > 9))+ 
  mytheme +
  scale_x_continuous(limits=c(2005,2015), breaks=c(2006, 2008, 2010, 2012, 2014)) + 
  theme(axis.text.x = element_text(angle=45, hjust=1)) +
  ylab('# of studies') + xlab('1st year the metric was observed')
filename<-"plot_codeFreq.png"
mypath<-file.path("/Users/mrl17/Desktop/Figures_ESA2015", "figures", filename)
png(mypath, units='in', width = 5.5, height = 4, res=300)
codeFreq.Plot
dev.off()
```  
![alt text](figures/plot_codeFreq.png)

How many metrics per study?
```{r metrics4,echo=FALSE, warning=FALSE}
numFDcodes.Plot<-ggplot(summ.ID, aes(x =nCode)) +
  geom_histogram(binwidth=1) +
  xlab("# of metrics per study") +
  scale_x_continuous(expand = c(0,0), breaks=1:10, limits=c(1,10)) +
  scale_y_continuous(expand = c(0,0)) +
  ylab("Count") + mytheme 

filename<-"plot_numFDcode.png"
mypath<-file.path("/Users/mrl17/Desktop/Figures_ESA2015", "figures", filename)
png(mypath, units='in', width = 3, height = 2, res=300)
numFDcodes.Plot
dev.off()
```  
![alt text](figures/plot_numFDcode.png)

What % of studies use only 1 diversity metric?
```{r metrics5,echo=FALSE, warning=FALSE}
selection<-length(which(summ.ID$nCode == 1))
total<-length(unique(summ.ID$ID))
answer<-round((selection/total)*100, digits=0)
paste(answer, '% of studies use only 1 functional diversity metric')
paste(100-answer, '% of studies use >1 functional diversity metric')
```  

Of studies that use only 1 diversity metric, what is it?
```{r metrics6,echo=FALSE, warning=FALSE}
only1IDs<-summ.ID[summ.ID$nCode == 1,'ID']
df.only1IDs<-df.metric.annotated[df.metric.annotated$ID %in% only1IDs,]
summ.only1 <- ddply(df.only1IDs,~code, summarise, nID=length(unique(ID)))
summ.only1.o<-orderBy(~-nID, summ.only1)
total<-sum(summ.only1.o$nID)
rao<-summ.only1.o[1,'nID']
answer2<-round(((rao)/total)*100, digits=0)
paste('Of the studies that use only 1 FD metric,', answer2, '% use Rao')
```  

Rank the frequency that diversity dimensions are included.  
```{r metrics7,echo=FALSE, warning=FALSE}
summ.dim <- ddply(df.metric.annotated,~CAT_dimension, summarise, nID=length(unique(ID)))
summ.dim.o<-orderBy(~-nID, summ.dim)
positions<-summ.dim.o$CAT_dimension

#plot
dim.Plot<-ggplot(summ.dim.o, aes(x=CAT_dimension, y=nID)) + 
  geom_bar(stat='identity') + 
  ylab('# of studies') + xlab('Functional diversity dimension') +
  scale_y_continuous(expand=c(0,0), limits=c(0,120)) + scale_x_discrete(limits= positions) +
  mytheme + theme(axis.text.x = element_text(angle=45, hjust=1))
filename<-"plot_dim.png"
mypath<-file.path("/Users/mrl17/Desktop/Figures_ESA2015", "figures", filename)
png(mypath, units='in', width = 4, height = 3, res=300)
dim.Plot
dev.off()
```  
![alt text](figures/plot_dim.png)

Rank the frequency that diversity dimensions are included.  
Color by terrestrial/aquatic system and plant/animal taxa.
```{r metrics8,echo=FALSE, warning=FALSE}
summ.dim2 <- ddply(df.metric.annotated,~sys1Grp+CAT_dimension, summarise, nID=length(unique(ID)))
summ.dim2.o<-orderBy(~sys1Grp-nID, summ.dim2)
#use the previous positions

#plot
summ.dim2.o.1<-subset(summ.dim2.o, sys1Grp != 'other')
dim.Plot2<-ggplot(summ.dim2.o.1, aes(x=CAT_dimension, y=nID, fill=sys1Grp)) + 
  geom_bar(stat='identity') + facet_wrap(~sys1Grp, ncol=2, scales='free_y')+
  ylab('# of studies') + xlab('Functional diversity dimension') +
  scale_y_continuous(expand=c(0,0)) + scale_x_discrete(limits= positions) +
  mytheme + theme(axis.text.x = element_text(angle=45, hjust=1))+
  scale_fill_manual(name='System and Taxa',
                    labels=c('Terrestrial plant','Terrestrial animal',
                             'Aquatic plant','Aquatic animal','Other'),
                    values=c('#008000','#329932',
                             '#1F497D','#4b6d97','#D72027'))
filename<-"plot_dim_facet.png"
mypath<-file.path("/Users/mrl17/Desktop/Figures_ESA2015", "figures", filename)
png(mypath, units='in', width = 9, height = 6, res=300)
dim.Plot2
dev.off()
```  
![alt text](figures/plot_dim_facet.png)

What % of studies use only 1 diversity dimension?
```{r metrics9,echo=FALSE, warning=FALSE}
selection<-length(which(summ.ID$nDim == 1))
total<-length(unique(summ.ID$ID))
answer<-round((selection/total)*100, digits=0)
paste(answer, '% of studies use only 1 dimension of functional diversity, e.g. divergence, richness, etc.')
paste(100-answer, '% of studies use >1 dimension of functional diversity, e.g. divergence, richness, etc.')
```  

Of studies that use only 1 diversity dimension, what is it?  
```{r metrics10,echo=FALSE, warning=FALSE}
only1IDs<-summ.ID[summ.ID$nDim == 1,'ID']
df.only1IDs<-df.metric.annotated[df.metric.annotated$ID %in% only1IDs,]
summ.only1 <- ddply(df.only1IDs,~CAT_dimension, summarise, nID=length(unique(ID)))
summ.only1.o<-orderBy(~-nID, summ.only1)
total<-sum(summ.only1.o$nID)
diverg<-summ.only1.o[1,'nID']
answer<-round(((diverg)/total)*100, digits=0)
paste('Of the studies that use only 1 FD dimension,', answer, '% use divergence')
```  

Of the studies that use >1 metric, what % look at >1 diversity dimension?  
```{r metrics11,echo=FALSE, warning=FALSE}
selection<-length(which(summ.ID$nCode > 1 & summ.ID$nDim > 1))
total<-length(which(summ.ID$nCode > 1))
answer<-round((selection/total)*100, digits=0)
paste(answer, '% of studies that use >1 FD metric use >1 FD dimension, e.g. divergence, richness, etc.')
```  

How many diversity dimensions per study?  
```{r metrics12,echo=FALSE, warning=FALSE}
numFDdim.Plot<-ggplot(summ.ID, aes(x =nDim)) +
  geom_histogram(binwidth=1)+xlab("# diversity dimensions per study") +
  ylab("Count") + mytheme +
  scale_x_continuous(expand = c(0,0), breaks=1:5, limits=c(1,5)) +
  scale_y_continuous(expand = c(0,0))
filename<-"plot_dimHist.png"
mypath<-file.path("/Users/mrl17/Desktop/Figures_ESA2015", "figures", filename)
png(mypath, units='in', width = 3, height = 2, res=300)
numFDdim.Plot
dev.off()
```  
![alt text](figures/plot_dimHist.png)

Rank the frequency that different multivariate methods are used.
```{r metrics13,echo=FALSE, warning=FALSE}
summ.meth <- ddply(df.metric.annotated,~CAT_multivarMethod, summarise, nID=length(unique(ID)))
summ.meth.o<-orderBy(~-nID, summ.meth)
positions<-summ.meth.o$CAT_multivarMethod

#plot
meth.Plot<-ggplot(summ.meth.o, aes(x=CAT_multivarMethod, y=nID)) + 
  geom_bar(stat='identity') + 
  ylab('# of studies') + xlab('Multivariate method') +
  scale_y_continuous(expand=c(0,0), limits=c(0,85)) + scale_x_discrete(limits= positions) +
  mytheme + theme(axis.text.x = element_text(angle=45, hjust=1))
filename<-"plot_meth.png"
mypath<-file.path("/Users/mrl17/Desktop/Figures_ESA2015", "figures", filename)
png(mypath, units='in', width = 5.5, height = 4, res=300)
meth.Plot
dev.off()
```  
![alt text](figures/plot_meth.png)

Rank the frequency that different multivariate methods are used.
Color by terrestrial/aquatic system and plant/animal taxa.
```{r metrics14,echo=FALSE, warning=FALSE}
summ.meth2 <- ddply(df.metric.annotated,~sys1Grp+CAT_multivarMethod, summarise, nID=length(unique(ID)))
summ.meth2.o<-orderBy(~sys1Grp-nID, summ.meth2)
#use the previous positions

#plot
meth.Plot2<-ggplot(summ.meth2.o, aes(x=CAT_multivarMethod, y=nID, fill=sys1Grp)) + 
  geom_bar(stat='identity') + facet_wrap(~sys1Grp, ncol=2, scales='free_y') +
  ylab('# of studies') + xlab('Multivariate method') +
  scale_y_continuous(expand=c(0,0)) + scale_x_discrete(limits= positions) +
  mytheme + theme(axis.text.x = element_text(angle=45, hjust=1))+
  scale_fill_manual(name='System and Taxa',
                    labels=c('Terrestrial plant','Terrestrial animal',
                             'Aquatic plant','Aquatic animal','Other'),
                    values=c('#008000','#329932',
                             '#1F497D','#4b6d97','#D72027'))
```  

What % of studies use only 1 multivariate method?
```{r metrics15,echo=FALSE, warning=FALSE}
selection<-length(which(summ.ID$nMeth == 1))
total<-length(unique(summ.ID$ID))
answer<-round((selection/total)*100, digits=0)
paste(answer, '% of studies use only 1 multivariate method to calculate functional diversity, e.g. ordinate, cluster, other')
paste(100-answer, '% of studies use only 1 multivariate method to calculate functional diversity, e.g. ordinate, cluster, other')
```  

Of the studies that use only 1 multivariate method, what is it?  
```{r metrics16,echo=FALSE, warning=FALSE}
only1IDs<-summ.ID[summ.ID$nMeth == 1,'ID']
df.only1IDs<-df.metric.annotated[df.metric.annotated$ID %in% only1IDs,]
summ.only1 <- ddply(df.only1IDs,~CAT_multivarMethod, summarise, nID=length(unique(ID)))
summ.only1.o<-orderBy(~-nID, summ.only1)
total<-sum(summ.only1.o$nID)
ordin<-summ.only1.o[1,'nID']
answer<-round(((ordin)/total)*100, digits=0)
paste('Of the studies that use only 1 FD method,', answer, '% use ordination')
```  

Of the studies that use >1 metric, what % look at >1 multivariate method?  
```{r metrics17,echo=FALSE, warning=FALSE}
selection<-length(which(summ.ID$nCode > 1 & summ.ID$nMeth > 1))
total<-length(which(summ.ID$nCode > 1))
answer<-round((selection/total)*100, digits=0)
paste(answer, '% of studies that use >1 FD metric, use >1 multivariate method for calculating functional diversity, e.g. ordinate, cluster, other')
```  

How many different multivariate methods per study?  
```{r metrics18,echo=FALSE, warning=FALSE}
numFDmeth.Plot<-ggplot(summ.ID, aes(x =nMeth)) +
  geom_histogram(binwidth=1) + xlab("# of methods per study") +
  ylab("Count") + mytheme +
  scale_x_continuous(expand = c(0,0), breaks=1:5, limits=c(1,4)) +
  scale_y_continuous(expand = c(0,0))
filename<-"plot_methHist.png"
mypath<-file.path("/Users/mrl17/Desktop/Figures_ESA2015", "figures", filename)
png(mypath, units='in', width = 4, height = 3, res=300)
numFDmeth.Plot
dev.off()
```  
![alt text](figures/plot_methHist.png)

What % of studies incorporate species abundance into at least 1 FD metric? 
Does it differ by terrestrial/aquatic system and plant/animal taxa?
```{r metrics19,echo=FALSE, warning=FALSE}
summ.abund <- ddply(df.metric.annotated,~CAT_abundance, summarise, nID=length(unique(ID)))
selection<-summ.abund[summ.abund$CAT_abundance=='yes','nID']
total<-sum(summ.abund[,'nID'])
answer<-round((selection/total)*100, digits=0)
paste(answer, '% of studies incorporate abundance into at least 1 of their functional diversity metrics')

summ.abund2 <- ddply(df.metric.annotated,~sys1Grp+CAT_abundance, summarise, nID=length(unique(ID)))
sum.abund3<-ddply(summ.abund2, ~sys1Grp, summarise, 
      totaln=sum(nID),
      percYes=(nID[CAT_abundance=='yes']/totaln)*100)
sum.abund3
```  

What % of studies use individual-scale data for at least 1 FD metric?  
```{r metrics20,echo=FALSE, warning=FALSE}
summ.scale1 <- ddply(df.metric.annotated,~CAT_scale1, summarise, nID=length(unique(ID)))
selection<-summ.scale1[summ.scale1$CAT_scale1=='individual','nID']
total<-sum(summ.scale1[,'nID'])
answer<-round((selection/total)*100, digits=0)
paste(answer, '% of studies use at least 1 individual-based functional diversity metric')

summ.scale2 <- ddply(df.metric.annotated,~sys1Grp+CAT_scale1, summarise, nID=length(unique(ID)))
paste('all individual-based studies were also on terrestrial plants')
```  



